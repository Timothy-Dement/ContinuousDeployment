- name: Create security group for an ec2 instance
  ec2_group:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    name: "security_M3"
    description: "Security group for M3"
    region: "{{ region }}"
    rules:
      - proto: all
        cidr_ip: 0.0.0.0/0
    rules_egress:
      - proto: all
        cidr_ip: 0.0.0.0/0
  register: security_firewall

# - name: Retrieve all tags on an instance
#   ec2_tag:
#     region: '{{ region }}'
#     resource: '{{ ansible_ec2_instance_id }}'
#     state: list
#   register: ec2_tags

- name: Create EC2 keypair for the project
  ec2_key:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    name: "{{ keyname }}"
    region: "{{ region }}"
    force: false
  register: ec2_key

- name: Save private key
  copy: content="{{ ec2_key.key.private_key }}" dest="/home/{{ ansible_ssh_user }}/{{ keyname }}.pem" mode=0600
  when: ec2_key.changed


- name: Launch instance
  ec2:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    key_name: "{{ keyname }}"
    group: "{{ security_firewall.group_name }}"
    instance_type: "{{ instance_type }}"
    image: "{{ image }}"
    wait: true
    region: "{{ region }}"
    vpc_subnet_id: "{{ subnet }}"
    assign_public_ip: yes
    instance_tags:
      Name: "{{group_name}}"
  register: ec2

- name: Add new instance to host group
  add_host:
    hostname: "{{ item.public_ip }}"
    groupname: "{{ group_name }}"
    ansible_ssh_user: ubuntu
    ansible_ssh_private_key_file: "/home/{{ansible_ssh_user}}/{{ keyname }}.pem"
  with_items: "{{ ec2.instances }}"

- name: Wait for SSH to come up
  wait_for:
    host: "{{ item.public_dns_name }}"
    port: 22
    delay: 60
    timeout: 1000
    state: started
  with_items: "{{ ec2.instances }}"

- name: Add group name to inventory file
  local_action: lineinfile dest=/home/vagrant/inventory insertafter=EOF line="[{{ group_name }}]" state=present create=yes
  with_items: "{{ ec2.instances }}"

- name: Add vm to group
  local_action: lineinfile dest=/home/vagrant/inventory regexp="{{ item.public_ip }}" insertafter="[{{ group_name }}]" line="{{ item.public_ip }} ansible_ssh_user=ubuntu ansible_ssh_private_key_file=/home/{{ansible_ssh_user}}/{{keyname}}.pem ansible_python_interpreter=/usr/bin/python3 ansible_ssh_extra_args='-o StrictHostKeyChecking=no'" state=present
  with_items: "{{ ec2.instances }}"

