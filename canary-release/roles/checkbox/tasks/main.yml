- name: Export MONGO_USER environment variable
  shell: "echo \"export MONGO_USER={{ MONGO_USER }}\" >> /etc/environment"

- name: Export MONGO_PORT environment variable
  shell: "echo \"export MONGO_PORT={{ MONGO_PORT }}\" >> /etc/environment"

- name: Export MONGO_PASS environment variable
  shell: "echo \"export MONGO_PASSWORD={{ MONGO_PASSWORD }}\" >> /etc/environment"

- name: Export MAIL_SMTP environment variable
  shell: "echo \"export MAIL_SMTP=smtp.gmail.com\" >> /etc/environment"

- name: Export MAIL_USER environment variable
  shell: "echo \"export MAIL_USER=csc519devopspipeliners\" >> /etc/environment"

- name: Export MAIL_PASSWORD environment variable
  shell: "echo \"export MAIL_PASSWORD=devops@2018\" >> /etc/environment"

- name: Export MONGO_IP environment variable
  shell: "echo \"export MONGO_IP={{ MONGO_IP }}\" >> /etc/environment"

- name: Install unzip
  apt:
    name: unzip

    
- name: update packages
  become: yes
  apt:
    upgrade: yes
    update_cache: yes

- name: install packages
  become: yes
  apt:
    name: "{{ item }}"
    update_cache: yes
  with_items:
    - "nodejs"
    - "npm"
    - "nodejs-legacy"
    - "mongodb-clients"

- name: Installing Python-Pip
  apt:
    pkg: python-pip
    state: latest


- name: Installing Python pip 3
  apt:
    pkg: python3-pip
    state: latest
- name: Install the latest pymongo package
  pip: name=pymongo state=latest use_mirrors=no


- name: Install nginx
  become: yes
  apt:
    pkg: nginx
    state: latest
    update_cache: yes

- name: Check if cloned repo exists
  stat:
    path: /home/{{ ansible_ssh_user }}/checkbox.io
  register: repo_dir

- name: Clone Checkbox
  git:
    repo: "https://{{ lookup('env', 'GITHUB_USERNAME') }}:{{ lookup('env', 'GITHUB_PASSWORD') }}@{{ GITHUB_REPO }}"
    dest: /home/{{ ansible_user }}/checkbox.io
  become: yes
  when: repo_dir.stat.isdir is not defined

- name: update location of public_html into default
  replace:
    dest: /home/{{ansible_ssh_user}}/checkbox.io/local-conf/default
    regexp: '/Users/gameweld/bitbucket/checkbox.io/checkbox.io/public_html'
    replace: '/home/{{ ansible_user }}/checkbox.io/public_html'

- name: Copy default to different location
  shell: "cp /home/{{ ansible_user }}/checkbox.io/local-conf/default /etc/nginx/sites-available/default"

- name: Copy nginx to diferent location
  shell: "cp /home/{{ ansible_user }}/checkbox.io/local-conf/nginx.conf /etc/nginx/nginx.conf"

- name: restart nginx
  service: name=nginx state=stopped enabled=no

# - name: Remove forever
#   npm: name=forever global=yes state=absent

- name: Install pm2 globally
  npm:
    name: pm2
    global: yes
    state: present

- name: Install checkbox.io npm packages
  npm:
    path: "/home/{{ ansible_user }}/checkbox.io/server-side/site"

- name: restart nginx
  service: name=nginx state=started enabled=no

- name: Start the server
  shell: "pm2 start server.js"
  args:
    chdir: "/home/{{ ansible_user }}/checkbox.io/server-side/site/"

